<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tracker</title>
    <style>
        :root { --theme-color:#ff8c00; }
        body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#1e1e1e; color:#f0f0f0; }
        .container { max-width:1500px; margin:0 auto; padding:20px; }
        h1,h2,h3 { color:var(--theme-color); border-bottom:2px solid #333; padding-bottom:6px; margin:16px 0 10px; }
        .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
        .tabs button { background:#3e3e3e; color:#f0f0f0; border:none; border-radius:8px 8px 0 0; padding:10px 14px; font-weight:600; cursor:pointer; }
        .tabs .active-main-tab { background:var(--theme-color); color:#1e1e1e; }
        .sub-tabs { border-bottom:2px solid #333; padding-bottom:8px; margin-bottom:16px; }
        .sub-tabs button { border-radius:6px 6px 0 0; }
        .sub-tabs .active-sub-tab { background:var(--theme-color); color:#1e1e1e; }
        .input-area { display:flex; gap:10px; flex-wrap:wrap; background:#2f2f2f; padding:12px; border-radius:8px; margin-bottom:16px; }
        .input-area input, .input-area select { flex:1; min-width:160px; padding:10px; border:1px solid #555; border-radius:6px; background:#3a3a3a; color:#f0f0f0; }
        .input-area button { flex:0; min-width:150px; }
        button { padding:10px 14px; border:none; border-radius:6px; background:var(--theme-color); color:#1e1e1e; font-weight:700; cursor:pointer; }
        button:hover { opacity:0.92; }
        .logout-btn { background:#555; color:#f0f0f0; }
        .color-picker-area { display:flex; align-items:center; gap:10px; margin:10px 0 16px; }
        .tracker-list { list-style:none; padding:0; margin:0; }
        .tracker-item { background:#3f3f3f; border-left:5px solid var(--theme-color); border-radius:8px; padding:12px; margin:10px 0; display:flex; flex-direction:column; gap:8px; }
        .tracker-item.watched { border-left-color:#28a745; opacity:0.92; }
        .item-details { display:flex; flex-direction:column; gap:6px; }
        .item-title-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .title-edit-input, .link-edit-input, .episodes-edit-input { display:none; padding:6px; border:1px solid var(--theme-color); border-radius:4px; background:#333; color:#f0f0f0; }
        .item-controls { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .save-button { background:#28a745; color:#fff; }
        .cancel-button { background:#6c757d; color:#fff; }
        .delete-button { background:#dc3545; color:#fff; }
        .episode-controls { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
        .notes-container { background:#2f2f2f; border-radius:6px; padding:10px; }
        .notes-label { color:var(--theme-color); font-weight:700; }
        .notes-textarea { display:none; width:100%; min-height:80px; padding:8px; border:1px solid #555; border-radius:6px; background:#333; color:#f0f0f0; }
        .notes-controls { display:flex; gap:8px; margin-top:6px; }
        #login-screen { position:fixed; inset:0; background:#1e1e1e; display:none; align-items:center; justify-content:center; z-index:1000; }
        .login-box { background:#2b2b2b; padding:24px; border-radius:10px; width:90%; max-width:420px; box-shadow:0 8px 24px rgba(0,0,0,0.5); }
        #access-key-input { width:100%; padding:12px; border:1px solid #555; border-radius:6px; background:#3a3a3a; color:#f0f0f0; margin-bottom:12px; text-align:center; font-size:1.05em; }
        .login-button { width:100%; }
        .error-message { color:#dc3545; font-weight:700; margin-top:8px; }
        #advanced-info-toggle { background:#333; color:#f0f0f0; display:flex; justify-content:space-between; align-items:center; padding:8px 12px; border-radius:6px; }
        #advanced-info-content { display:none; background:#2f2f2f; border-top:1px solid #444; border-radius:0 0 6px 6px; padding:10px 12px; color:#ccc; }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <h2>üîê Priv√°t Tracker</h2>
            <p>Add meg a k√∂z√∂s titkos kulcsot:</p>
            <input type="password" id="access-key-input" placeholder="Titkos Kulcs">
            <button class="login-button" onclick="checkAccessKey()">Bel√©p√©s</button>
            <div id="login-error" class="error-message"></div>
        </div>
    </div>

    <div id="main-app-content" style="display:none;">
        <div class="container">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>üé¨ Tracker</h1>
                <button class="logout-btn" onclick="logout()">Kijelentkez√©s üö™</button>
            </div>

            <button id="advanced-info-toggle" onclick="toggleAdvancedInfo()">
                <span>Halad√≥ adatok (hibakeres√©s) ‚öôÔ∏è</span><span id="toggle-icon">‚ñº</span>
            </button>
            <div id="advanced-info-content">
                <p id="shared-id-info">K√∂z√∂s mappa ID: <strong></strong></p>
                <p id="user-id-info">Azonos√≠t√≥ (Anonim UID): <strong></strong></p>
            </div>

            <div class="color-picker-area">
                <span>Kiemel≈ë sz√≠n:</span>
                <input type="color" id="color-picker" value="#ff8c00" onchange="changeThemeColor(this.value)">
            </div>

            <div class="tabs">
                <button id="media-main-tab" class="active-main-tab" onclick="showMainTab('media')">üé¨ Filmek & Sorozatok</button>
                <button id="game-main-tab" onclick="showMainTab('game')">üéÆ J√°t√©kok</button>
            </div>

            <div id="media-content">
                <div id="media-sub-tabs" class="tabs sub-tabs">
                    <button id="joint-sub-tab" class="active-sub-tab" onclick="showSubTab('joint')">üßë‚Äçü§ù‚Äçüßë K√∂z√∂s n√©z√©s</button>
                    <button id="cdrama-sub-tab" onclick="showSubTab('cdrama')">üá®üá≥ C-Drama</button>
                    <button id="kdrama-sub-tab" onclick="showSubTab('kdrama')">üá∞üá∑ K-Drama</button>
                    <button id="anime-sub-tab" onclick="showSubTab('anime')">üáØüáµ Anime</button>
                    <button id="donghua-sub-tab" onclick="showSubTab('donghua')">üéé Donghua</button>
                    <button id="other-sub-tab" onclick="showSubTab('other')">üåç Egy√©b</button>
                </div>

                <h2 id="media-category-title">üßë‚Äçü§ù‚Äçüßë K√∂z√∂s n√©z√©s</h2>

                <div class="input-area">
                    <input type="text" id="cim-input" placeholder="C√≠m...">
                    <select id="tipus-select" onchange="toggleMaxEpisodeInput()">
                        <option value="film">Film</option>
                        <option value="sorozat">Sorozat</option>
                    </select>
                    <input type="number" id="max-epizod-input" placeholder="Max epiz√≥d" style="display:none;">
                    <input type="url" id="link-input" placeholder="Link (pl. IMDb)">
                    <button onclick="addNewItem()">Hozz√°ad√°s</button>
                </div>

                <h3>N√©zend≈ë</h3>
                <ul id="nezendo-lista" class="tracker-list"></ul>

                <h3>Megn√©zve</h3>
                <ul id="megnezve-lista" class="tracker-list"></ul>
            </div>

            <div id="game-tracker-content" style="display:none;">
                <h2>üéÆ J√°t√©kok</h2>
                <div class="input-area">
                    <input type="text" id="game-cim-input" placeholder="J√°t√©k c√≠me...">
                    <select id="game-platform-select">
                        <option value="PC">PC</option>
                        <option value="PlayStation">PlayStation</option>
                        <option value="Xbox">Xbox</option>
                        <option value="Switch">Switch</option>
                        <option value="Mobil">Mobil</option>
                    </select>
                    <button onclick="addNewGame()">Hozz√°ad√°s</button>
                </div>

                <h3>J√°tszand√≥</h3>
                <ul id="game-nezendo-lista" class="tracker-list"></ul>

                <h3>Kij√°tszott</h3>
                <ul id="game-megnezve-lista" class="tracker-list"></ul>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAKEKZzgKSTFQ3_K6Yhm7aPvTX5plMzXYg",
        authDomain: "tracker-fbe21.firebaseapp.com",
        projectId: "tracker-fbe21",
        storageBucket: "tracker-fbe21.firebasestorage.app",
        messagingSenderId: "402979419538",
        appId: "1:402979419538:web:ff7924c73c306ff8527d4b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Biztons√°g: titkos kulcs (Base64: "0013")
    const ENCODED_ACCESS_KEY = "MDAxMw==";
    const ACCESS_KEY_LOCAL_STORAGE = "trackerAccessGranted";

    const SHARED_UID = "SHARED_FRIENDS_GROUP";
    const MEDIA_COLLECTION_NAME = "media";
    const GAME_COLLECTION_NAME = "games";

    let trackerList = [];
    let gameList = [];
    let currentCategory = "joint";

    const CATEGORY_MAP = {
        joint: "üßë‚Äçü§ù‚Äçüßë K√∂z√∂s n√©z√©s",
        cdrama: "üá®üá≥ C-Drama",
        kdrama: "üá∞üá∑ K-Drama",
        anime: "üáØüáµ Anime",
        donghua: "üéé Donghua",
        other: "üåç Egy√©b"
    };

    // Bel√©p√©s
    window.checkAccessKey = function() {
        const inputKey = document.getElementById('access-key-input').value.trim();
        const errorDiv = document.getElementById('login-error');
        const SECRET_ACCESS_KEY = atob(ENCODED_ACCESS_KEY);

        if (inputKey === SECRET_ACCESS_KEY) {
            localStorage.setItem(ACCESS_KEY_LOCAL_STORAGE, 'true');
            errorDiv.textContent = '';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app-content').style.display = 'block';
            initAuthAndApp();
        } else {
            errorDiv.textContent = 'Hib√°s titkos kulcs!';
            localStorage.removeItem(ACCESS_KEY_LOCAL_STORAGE);
        }
    }

    function checkInitialAccess() {
        if (localStorage.getItem(ACCESS_KEY_LOCAL_STORAGE) === 'true') {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app-content').style.display = 'block';
            initAuthAndApp();
        } else {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app-content').style.display = 'none';
        }
    }

    window.logout = function() {
        localStorage.removeItem(ACCESS_KEY_LOCAL_STORAGE);
        location.reload();
    }

    window.toggleAdvancedInfo = function() {
        const c = document.getElementById('advanced-info-content');
        const icon = document.getElementById('toggle-icon');
        const isHidden = c.style.display === 'none' || c.style.display === '';
        c.style.display = isHidden ? 'block' : 'none';
        icon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
    }

    async function initAuthAndApp() {
        try {
            const cred = await signInAnonymously(auth);
            document.getElementById('shared-id-info').querySelector('strong').textContent = SHARED_UID;
            document.getElementById('user-id-info').querySelector('strong').textContent = cred.user.uid;

            loadThemeColor();
            startFirestoreListeners();
            showMainTab('media');
        } catch (e) {
            console.error("Auth hiba:", e);
        }
    }

    function getMediaCollectionRef() {
        return collection(db, 'users', SHARED_UID, MEDIA_COLLECTION_NAME);
    }
    function getGameCollectionRef() {
        return collection(db, 'users', SHARED_UID, GAME_COLLECTION_NAME);
    }

    function startFirestoreListeners() {
        onSnapshot(getMediaCollectionRef(), (snapshot) => {
            trackerList = snapshot.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
            renderLists();
        }, (e) => console.error("Media figyel√©s hiba:", e));

        onSnapshot(getGameCollectionRef(), (snapshot) => {
            gameList = snapshot.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
            renderGameLists();
        }, (e) => console.error("Game figyel√©s hiba:", e));
    }

    window.addNewItem = async function() {
        const cim = document.getElementById('cim-input').value.trim();
        const tipus = document.getElementById('tipus-select').value;
        const maxEp = document.getElementById('max-epizod-input').value;
        const link = document.getElementById('link-input').value.trim();

        if (!cim) return;

        const newItem = {
            cim,
            tipus,
            statusz: "n√©zend≈ë",
            watchedEpisodes: tipus === 'sorozat' ? 0 : null,
            maxEpisodes: tipus === 'sorozat' && maxEp ? parseInt(maxEp,10) : null,
            link: link || null,
            category: currentCategory,
            notes: ""
        };

        try { await addDoc(getMediaCollectionRef(), newItem); } catch(e) { console.error(e); }
        document.getElementById('cim-input').value = '';
        document.getElementById('max-epizod-input').value = '';
        document.getElementById('link-input').value = '';
    }

    window.deleteItem = async function(firestoreId) {
        try { await deleteDoc(doc(getMediaCollectionRef(), firestoreId)); } catch(e) { console.error(e); }
    }

    window.updateStatus = async function(firestoreId, newStatus) {
        try { await updateDoc(doc(getMediaCollectionRef(), firestoreId), { statusz: newStatus }); } catch(e) { console.error(e); }
    }

    window.changeEpisodeCount = async function(firestoreId, delta) {
        const item = trackerList.find(i => i.firestoreId === firestoreId);
        if (!item || item.tipus !== 'sorozat') return;

        let newCount = (item.watchedEpisodes ?? 0) + delta;
        newCount = Math.max(0, newCount);
        if (item.maxEpisodes) newCount = Math.min(newCount, item.maxEpisodes);

        let newStatus = item.statusz;
        if (item.maxEpisodes && newCount === item.maxEpisodes) newStatus = 'megn√©zve';
        else if (newStatus === 'megn√©zve' && item.maxEpisodes && newCount < item.maxEpisodes) newStatus = 'n√©zend≈ë';

        try { await updateDoc(doc(getMediaCollectionRef(), firestoreId), { watchedEpisodes: newCount, statusz: newStatus }); } catch(e) { console.error(e); }
    }

    // Ment√©s: azonnal updateDoc, ut√°na visszav√°lt n√©zetre
    window.saveItemDetails = async function(firestoreId) {
        const titleInput = document.getElementById(`title-edit-${firestoreId}`);
        const linkInput = document.getElementById(`link-edit-${firestoreId}`);
        const episodesInput = document.getElementById(`episodes-edit-${firestoreId}`);

        const updates = {};
        if (titleInput) {
            const newTitle = titleInput.value.trim();
            if (newTitle) updates.cim = newTitle;
        }
        if (linkInput) {
            const newLink = linkInput.value.trim();
            updates.link = newLink || null;
        }

        let newMax = null;
        if (episodesInput) {
            const parsed = parseInt(episodesInput.value, 10);
            if (!isNaN(parsed) && parsed >= 0) {
                updates.maxEpisodes = parsed;
                newMax = parsed;
            } else {
                updates.maxEpisodes = null;
                newMax = null;
            }
        }

        const item = trackerList.find(i => i.firestoreId === firestoreId);
        if (item && item.tipus === 'sorozat' && episodesInput) {
            const watched = item.watchedEpisodes ?? 0;
            const limit = newMax ?? item.maxEpisodes ?? null;
            if (limit !== null) {
                const corrected = Math.min(watched, limit);
                updates.watchedEpisodes = corrected;
                updates.statusz = limit > 0 && corrected === limit ? 'megn√©zve' : 'n√©zend≈ë';
            } else {
                updates.statusz = 'n√©zend≈ë';
            }
        }

        try {
            await updateDoc(doc(getMediaCollectionRef(), firestoreId), updates);
            toggleEditMode(firestoreId);
        } catch (e) {
            console.error("Ment√©si hiba:", e);
        }
    }

    // Szerkeszt√©si m√≥d v√°lt√°sa
    window.toggleEditMode = function(firestoreId) {
        const titleDisplay = document.getElementById(`title-display-${firestoreId}`);
        const titleInput = document.getElementById(`title-edit-${firestoreId}`);
        const linkDisplay = document.getElementById(`link-display-${firestoreId}`);
        const linkInput = document.getElementById(`link-edit-${firestoreId}`);
        const episodesDisplay = document.getElementById(`episodes-display-${firestoreId}`);
        const episodesInput = document.getElementById(`episodes-edit-${firestoreId}`);
        const editBtn = document.getElementById(`edit-btn-${firestoreId}`);
        const saveBtn = document.getElementById(`save-btn-${firestoreId}`);
        const cancelBtn = document.getElementById(`cancel-btn-${firestoreId}`);

        const isEditing = titleInput && titleInput.style.display !== 'none';

        if (!isEditing) {
            if (titleDisplay) titleDisplay.style.display = 'none';
            if (titleInput) { titleInput.style.display = 'inline-block'; titleInput.focus(); }
            if (linkDisplay) linkDisplay.style.display = 'none';
            if (linkInput) linkInput.style.display = 'inline-block';
            if (episodesDisplay) episodesDisplay.style.display = 'none';
            if (episodesInput) episodesInput.style.display = 'inline-block';
            if (editBtn) editBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'inline-block';
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
        } else {
            if (titleDisplay) titleDisplay.style.display = 'inline-block';
            if (titleInput) titleInput.style.display = 'none';
            if (linkDisplay) linkDisplay.style.display = 'inline-block';
            if (linkInput) linkInput.style.display = 'none';
            if (episodesDisplay) episodesDisplay.style.display = 'inline-block';
            if (episodesInput) episodesInput.style.display = 'none';
            if (editBtn) editBtn.style.display = 'inline-block';
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    }

    // Megjegyz√©sek
    window.saveNotes = async function(firestoreId) {
        const ta = document.getElementById(`notes-edit-${firestoreId}`);
        if (!ta) return;
        const newNotes = ta.value;

        try { await updateDoc(doc(getMediaCollectionRef(), firestoreId), { notes: newNotes }); } catch(e) { console.error(e); }
        toggleNotesEditMode(firestoreId);
    }

    window.toggleNotesEditMode = function(firestoreId) {
        const display = document.getElementById(`notes-display-${firestoreId}`);
        const textarea = document.getElementById(`notes-edit-${firestoreId}`);
        const editBtn = document.getElementById(`notes-edit-btn-${firestoreId}`);
        const saveBtn = document.getElementById(`notes-save-btn-${firestoreId}`);
        const cancelBtn = document.getElementById(`notes-cancel-btn-${firestoreId}`);

        const isEditing = textarea && textarea.style.display !== 'none';

        if (!isEditing) {
            if (display) display.style.display = 'none';
            if (textarea) { textarea.style.display = 'block'; textarea.focus(); }
            if (editBtn) editBtn.style.display = 'none';
            if (saveBtn) saveBtn.style.display = 'inline-block';
            if (cancelBtn) cancelBtn.style.display = 'inline-block';
        } else {
            if (display) display.style.display = 'block';
            if (textarea) textarea.style.display = 'none';
            if (editBtn) editBtn.style.display = 'inline-block';
            if (saveBtn) saveBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    }

    // J√°t√©kok
    window.addNewGame = async function() {
        const cim = document.getElementById('game-cim-input').value.trim();
        const platform = document.getElementById('game-platform-select').value;
        if (!cim) return;

        try { await addDoc(getGameCollectionRef(), { cim, platform, statusz: 'j√°tszand√≥' }); } catch(e) { console.error(e); }
        document.getElementById('game-cim-input').value = '';
    }

    window.updateGameStatus = async function(firestoreId, newStatus) {
        try { await updateDoc(doc(getGameCollectionRef(), firestoreId), { statusz: newStatus }); } catch(e) { console.error(e); }
    }

    window.deleteGameItem = async function(firestoreId) {
        try { await deleteDoc(doc(getGameCollectionRef(), firestoreId)); } catch(e) { console.error(e); }
    }

    // UI seg√©dek
    window.showMainTab = function(tabName) {
        const mediaContent = document.getElementById('media-content');
        const gameContent = document.getElementById('game-tracker-content');

        document.getElementById('media-main-tab').classList.remove('active-main-tab');
        document.getElementById('game-main-tab').classList.remove('active-main-tab');
        document.getElementById(`${tabName}-main-tab`).classList.add('active-main-tab');

        if (tabName === 'media') {
            mediaContent.style.display = 'block';
            gameContent.style.display = 'none';
            document.getElementById('media-sub-tabs').style.display = 'flex';
            showSubTab(currentCategory);
        } else {
            mediaContent.style.display = 'none';
            gameContent.style.display = 'block';
            document.getElementById('media-sub-tabs').style.display = 'none';
        }
    }

    window.showSubTab = function(category) {
        currentCategory = category;
        document.getElementById('media-category-title').textContent = CATEGORY_MAP[category];

        ['joint','cdrama','kdrama','anime','donghua','other'].forEach(cat => {
            const btn = document.getElementById(`${cat}-sub-tab`);
            if (btn) btn.classList.toggle('active-sub-tab', cat === category);
        });

        renderLists();
    }

    window.changeThemeColor = function(newColor) {
        document.documentElement.style.setProperty('--theme-color', newColor);
        localStorage.setItem('trackerThemeColor', newColor);
    }

    function loadThemeColor() {
        const saved = localStorage.getItem('trackerThemeColor') || '#ff8c00';
        const picker = document.getElementById('color-picker');
        if (picker) picker.value = saved;
        changeThemeColor(saved);
    }

    window.toggleMaxEpisodeInput = function() {
        const type = document.getElementById('tipus-select').value;
        const maxInput = document.getElementById('max-epizod-input');
        if (type === 'sorozat') maxInput.style.display = 'block';
        else { maxInput.style.display = 'none'; maxInput.value = ''; }
    }

    function renderLists() {
        const nezendoUl = document.getElementById('nezendo-lista');
        const megnezveUl = document.getElementById('megnezve-lista');
        if (!nezendoUl || !megnezveUl) return;

        nezendoUl.innerHTML = '';
        megnezveUl.innerHTML = '';

        const filtered = trackerList.filter(i => (i.category || 'joint') === currentCategory);

        filtered.forEach(item => {
            const li = document.createElement('li');
            li.className = `tracker-item ${item.statusz === 'megn√©zve' ? 'watched' : ''}`;

            const details = document.createElement('div');
            details.className = 'item-details';

            const titleRow = document.createElement('div');
            titleRow.className = 'item-title-row';

            const titleDisplay = document.createElement('strong');
            titleDisplay.id = `title-display-${item.firestoreId}`;
            titleDisplay.textContent = item.cim;

            const titleInput = document.createElement('input');
            titleInput.id = `title-edit-${item.firestoreId}`;
            titleInput.className = 'title-edit-input';
            titleInput.value = item.cim;
            titleInput.type = 'text';
            titleInput.onkeypress = (e) => { if (e.key === 'Enter') saveItemDetails(item.firestoreId); };

            const editBtn = document.createElement('button');
            editBtn.id = `edit-btn-${item.firestoreId}`;
            editBtn.textContent = '‚úèÔ∏è Szerkeszt√©s';
            editBtn.onclick = () => toggleEditMode(item.firestoreId);

            const saveBtn = document.createElement('button');
            saveBtn.id = `save-btn-${item.firestoreId}`;
            saveBtn.className = 'save-button';
            saveBtn.style.display = 'none';
            saveBtn.textContent = 'üíæ Ment√©s';
            saveBtn.onclick = () => saveItemDetails(item.firestoreId);

            const cancelBtn = document.createElement('button');
            cancelBtn.id = `cancel-btn-${item.firestoreId}`;
            cancelBtn.className = 'cancel-button';
            cancelBtn.style.display = 'none';
            cancelBtn.textContent = '‚ùå M√©gse';
            cancelBtn.onclick = () => toggleEditMode(item.firestoreId);

            titleRow.appendChild(titleDisplay);
            titleRow.appendChild(titleInput);
            titleRow.appendChild(editBtn);
            titleRow.appendChild(saveBtn);
            titleRow.appendChild(cancelBtn);
            details.appendChild(titleRow);

            const typeSpan = document.createElement('span');
            typeSpan.textContent = `(${item.tipus === 'sorozat' ? 'Sorozat' : 'Film'})`;
            details.appendChild(typeSpan);

            // Link display + edit
            const linkDisplay = item.link
                ? document.createElement('a')
                : document.createElement('span');
            linkDisplay.id = `link-display-${item.firestoreId}`;
            if (item.link) {
                linkDisplay.href = item.link;
                linkDisplay.textContent = 'Link üîó';
                linkDisplay.target = '_blank';
            } else {
                linkDisplay.textContent = 'Nincs link';
                linkDisplay.style.color = '#aaa';
            }
            details.appendChild(linkDisplay);

            const linkInput = document.createElement('input');
            linkInput.id = `link-edit-${item.firestoreId}`;
            linkInput.className = 'link-edit-input';
            linkInput.type = 'url';
            linkInput.value = item.link || '';
            details.appendChild(linkInput);

            // Episodes display + edit
            if (item.tipus === 'sorozat') {
                const epDisplay = document.createElement('span');
                epDisplay.id = `episodes-display-${item.firestoreId}`;
                epDisplay.textContent = `Max epiz√≥d: ${item.maxEpisodes ?? 'nincs'}`;
                details.appendChild(epDisplay);

                const epInput = document.createElement('input');
                epInput.id = `episodes-edit-${item.firestoreId}`;
                epInput.className = 'episodes-edit-input';
                epInput.type = 'number';
                epInput.value = item.maxEpisodes ?? '';
                details.appendChild(epInput);
            }

            li.appendChild(details);

            const controls = document.createElement('div');
            controls.className = 'item-controls';

            if (item.tipus === 'sorozat') {
                const epControls = document.createElement('div');
                epControls.className = 'episode-controls';
                const watched = item.watchedEpisodes ?? 0;
                const max = item.maxEpisodes ?? '?';
                epControls.innerHTML = `
                    <span>K√∂vetkez≈ë epiz√≥d: <strong style="color:var(--theme-color)">${watched + 1}</strong></span>
                    <span>Halad√°s: <strong>${watched}${max !== '?' ? ' / ' + max : ''}</strong></span>
                `;
                const minus = document.createElement('button'); minus.textContent = '-'; minus.onclick = () => changeEpisodeCount(item.firestoreId, -1);
                const plus = document.createElement('button'); plus.textContent = '+'; plus.onclick = () => changeEpisodeCount(item.firestoreId, 1);
                epControls.appendChild(minus); epControls.appendChild(plus);
                controls.appendChild(epControls);
            }

            const statusBtn = document.createElement('button');
            if (item.statusz === 'n√©zend≈ë') {
                statusBtn.textContent = 'Megn√©ztem';
                statusBtn.onclick = () => updateStatus(item.firestoreId, 'megn√©zve');
            } else {
                statusBtn.textContent = 'M√©gse l√°ttam';
                statusBtn.onclick = () => updateStatus(item.firestoreId, 'n√©zend≈ë');
            }
            controls.appendChild(statusBtn);

            const delBtn = document.createElement('button');
            delBtn.className = 'delete-button';
            delBtn.textContent = 'üóëÔ∏è T√∂rl√©s';
            delBtn.onclick = () => deleteItem(item.firestoreId);
            controls.appendChild(delBtn);

            li.appendChild(controls);

            // Notes
            const notes = document.createElement('div');
            notes.className = 'notes-container';
            const label = document.createElement('div'); label.className = 'notes-label'; label.textContent = 'Megjegyz√©sek:'; notes.appendChild(label);
            const notesDisplay = document.createElement('div'); notesDisplay.id = `notes-display-${item.firestoreId}`; notesDisplay.textContent = item.notes || 'Nincs megjegyz√©s.'; notes.appendChild(notesDisplay);
            const notesTextarea = document.createElement('textarea'); notesTextarea.id = `notes-edit-${item.firestoreId}`; notesTextarea.className = 'notes-textarea'; notes.appendChild(notesTextarea);
            const notesCtrls = document.createElement('div'); notesCtrls.className = 'notes-controls';
            const nEdit = document.createElement('button'); nEdit.id = `notes-edit-btn-${item.firestoreId}`; nEdit.textContent = '‚úèÔ∏è Szerkeszt√©s'; nEdit.onclick = () => toggleNotesEditMode(item.firestoreId);
            const nSave = document.createElement('button'); nSave.id = `notes-save-btn-${item.firestoreId}`; nSave.textContent = 'üíæ Ment√©s'; nSave.className = 'save-button'; nSave.style.display='none'; nSave.onclick = () => saveNotes(item.firestoreId);
            const nCancel = document.createElement('button'); nCancel.id = `notes-cancel-btn-${item.firestoreId}`; nCancel.textContent = '‚ùå M√©gse'; nCancel.className = 'cancel-button'; nCancel.style.display='none'; nCancel.onclick = () => toggleNotesEditMode(item.firestoreId);
            notesCtrls.appendChild(nEdit); notesCtrls.appendChild(nSave); notesCtrls.appendChild(nCancel);
            notes.appendChild(notesCtrls);
            li.appendChild(notes);

            if (item.statusz === 'n√©zend≈ë') nezendoUl.appendChild(li); else megnezveUl.appendChild(li);
        });
    }

    function renderGameLists() {
        const n = document.getElementById('game-nezendo-lista');
        const m = document.getElementById('game-megnezve-lista');
        if (!n || !m) return;
        n.innerHTML = ''; m.innerHTML = '';
        gameList.forEach(item => {
            const li = document.createElement('li'); li.className = `tracker-item ${item.statusz === 'kij√°tszottam' ? 'watched' : ''}`;
            const d = document.createElement('div'); d.className = 'item-details'; d.innerHTML = `<strong>${item.cim}</strong><span>(${item.platform})</span>`;
            const ctrls = document.createElement('div'); ctrls.className = 'item-controls';
            const statusBtn = document.createElement('button');
            if (item.statusz === 'j√°tszand√≥') { statusBtn.textContent = 'Kij√°tszottam'; statusBtn.onclick = () => updateGameStatus(item.firestoreId, 'kij√°tszottam'); }
            else { statusBtn.textContent = 'M√©gse j√°tszottam'; statusBtn.onclick = () => updateGameStatus(item.firestoreId, 'j√°tszand√≥'); }
            const delBtn = document.createElement('button'); delBtn.className='delete-button'; delBtn.textContent='üóëÔ∏è T√∂rl√©s'; delBtn.onclick = () => deleteGameItem(item.firestoreId);
            ctrls.appendChild(statusBtn); ctrls.appendChild(delBtn);
            li.appendChild(d); li.appendChild(ctrls);
            if (item.statusz === 'j√°tszand√≥') n.appendChild(li); else m.appendChild(li);
        });
    }

    window.onload = () => {
        toggleMaxEpisodeInput();
        checkInitialAccess();
    };
</script>
</body>
</html>
