<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Tracker</title>
  <style>
    :root { --theme-color:#ff8c00; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:0; background:#1e1e1e; color:#f0f0f0; padding:20px; display:flex; justify-content:center; }
    .container { width:100%; max-width:1500px; background:#282828; padding:20px; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,0.5); }
    h1,h2,h3 { color:var(--theme-color); border-bottom:2px solid #3d3d3d; padding-bottom:5px; }
    .tabs { display:flex; flex-wrap:wrap; margin-bottom:10px; }
    .tabs button { background:#3e3e3e; color:#f0f0f0; margin-right:5px; margin-bottom:5px; padding:10px 15px; border:none; border-radius:8px 8px 0 0; cursor:pointer; font-weight:bold; }
    .tabs .active-main-tab { background:var(--theme-color); color:#1e1e1e; }
    .sub-tabs { margin-top:10px; border-bottom:2px solid #3e3e3e; margin-bottom:20px; }
    .sub-tabs button { border-radius:6px 6px 0 0; font-size:0.9em; padding:8px 12px; background:#4c4c4c; }
    .sub-tabs .active-sub-tab { background:var(--theme-color); color:#1e1e1e; }
    .input-area { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; background:#3e3e3e; padding:15px; border-radius:8px; }
    .input-area input, .input-area select { flex:1; min-width:150px; padding:10px; border:1px solid #555; border-radius:6px; background:#3e3e3e; color:#f0f0f0; }
    .tracker-list { list-style:none; padding:0; }
    .tracker-item { background:#444; padding:15px; margin-bottom:10px; border-radius:8px; border-left:5px solid var(--theme-color); box-shadow:0 4px 6px rgba(0,0,0,0.4); }
    .tracker-item.watched { border-left-color:#28a745; opacity:0.9; }
    .item-details { display:flex; flex-direction:column; gap:6px; }
    .item-title-row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .title-edit-input,.link-edit-input,.episodes-edit-input { display:none; padding:6px; border:1px solid var(--theme-color); border-radius:4px; background:#333; color:#f0f0f0; }
    .item-controls { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .save-button { background:#28a745; color:#fff; }
    .cancel-button { background:#6c757d; color:#fff; }
    .delete-button { background:#dc3545; color:#fff; }
    .episode-controls { display:flex; gap:8px; flex-wrap:wrap; }
    .notes-container { background:#3e3e3e; padding:10px; border-radius:6px; margin-top:10px; }
    .notes-label { color:var(--theme-color); font-weight:bold; }
    .notes-textarea { display:none; width:100%; min-height:80px; padding:8px; border:1px solid #555; border-radius:4px; background:#333; color:#f0f0f0; }
    .notes-controls { display:flex; gap:8px; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ Tracker</h1>
    <div class="tabs">
      <button id="media-main-tab" class="active-main-tab" onclick="showMainTab('media')">ğŸ¬ Filmek & Sorozatok</button>
      <button id="game-main-tab" onclick="showMainTab('game')">ğŸ® JÃ¡tÃ©kok</button>
    </div>

    <!-- MÃ©dia tartalom -->
    <div id="media-content">
      <div class="tabs sub-tabs">
        <button id="joint-sub-tab" class="active-sub-tab" onclick="showSubTab('joint')">ğŸ§‘â€ğŸ¤â€ğŸ§‘ KÃ¶zÃ¶s</button>
        <button id="cdrama-sub-tab" onclick="showSubTab('cdrama')">ğŸ‡¨ğŸ‡³ C-Drama</button>
        <button id="kdrama-sub-tab" onclick="showSubTab('kdrama')">ğŸ‡°ğŸ‡· K-Drama</button>
        <button id="anime-sub-tab" onclick="showSubTab('anime')">ğŸ‡¯ğŸ‡µ Anime</button>
        <button id="donghua-sub-tab" onclick="showSubTab('donghua')">ğŸ Donghua</button>
        <button id="other-sub-tab" onclick="showSubTab('other')">ğŸŒ EgyÃ©b</button>
      </div>

      <h2 id="media-category-title">ğŸ§‘â€ğŸ¤â€ğŸ§‘ KÃ¶zÃ¶s</h2>

      <div class="input-area">
        <input type="text" id="cim-input" placeholder="CÃ­m...">
        <select id="tipus-select" onchange="toggleMaxEpisodeInput()">
          <option value="film">Film</option>
          <option value="sorozat">Sorozat</option>
        </select>
        <input type="number" id="max-epizod-input" placeholder="Max epizÃ³d" style="display:none;">
        <input type="url" id="link-input" placeholder="Link (IMDb)">
        <button onclick="addNewItem()">HozzÃ¡adÃ¡s</button>
      </div>

      <h3>NÃ©zendÅ‘</h3>
      <ul id="nezendo-lista" class="tracker-list"></ul>

      <h3>MegnÃ©zve</h3>
      <ul id="megnezve-lista" class="tracker-list"></ul>
    </div>

    <!-- JÃ¡tÃ©k tartalom -->
    <div id="game-tracker-content" style="display:none;">
      <h2>ğŸ® JÃ¡tÃ©kok</h2>
      <div class="input-area">
        <input type="text" id="game-cim-input" placeholder="JÃ¡tÃ©k cÃ­me...">
        <select id="game-platform-select">
          <option value="PC">PC</option>
          <option value="PlayStation">PlayStation</option>
          <option value="Xbox">Xbox</option>
          <option value="Switch">Switch</option>
          <option value="Mobil">Mobil</option>
        </select>
        <button onclick="addNewGame()">HozzÃ¡adÃ¡s</button>
      </div>

      <h3>JÃ¡tszandÃ³</h3>
      <ul id="game-nezendo-lista" class="tracker-list"></ul>

      <h3>KijÃ¡tszott</h3>
      <ul id="game-megnezve-lista" class="tracker-list"></ul>
    </div>
  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAKEKZzgKSTFQ3_K6Yhm7aPvTX5plMzXYg",
  authDomain: "tracker-fbe21.firebaseapp.com",
  projectId: "tracker-fbe21",
  storageBucket: "tracker-fbe21.firebasestorage.app",
  messagingSenderId: "402979419538",
  appId: "1:402979419538:web:ff7924c73c306ff8527d4b"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const SHARED_UID = "SHARED_FRIENDS_GROUP";
const MEDIA_COLLECTION_NAME = "media";
const GAME_COLLECTION_NAME = "games";
let trackerList = [];
let gameList = [];
let currentCategory = "joint";

function getMediaCollectionRef() { return collection(db, "users", SHARED_UID, MEDIA_COLLECTION_NAME); }
function getGameCollectionRef() { return collection(db, "users", SHARED_UID, GAME_COLLECTION_NAME); }

signInAnonymously(auth).then(() => {
  onSnapshot(getMediaCollectionRef(), (snapshot) => {
    trackerList = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
    renderLists();
  });
  onSnapshot(getGameCollectionRef(), (snapshot) => {
    gameList = snapshot.docs.map(doc => ({ firestoreId: doc.id, ...doc.data() }));
    renderGameLists();
  });
});

// --- CRUD funkciÃ³k ---
window.addNewItem = async function() {
  const cim = document.getElementById('cim-input').value.trim();
  const tipus = document.getElementById('tipus-select').value;
  const maxEp = document.getElementById('max-epizod-input').value;
  const link = document.getElementById('link-input').value.trim();
  if (!cim) return;
  const newItem = {
    cim, tipus,
    statusz:"nÃ©zendÅ‘",
    watchedEpisodes: tipus==="sorozat"?0:null,
    maxEpisodes: tipus==="sorozat" && maxEp ? parseInt(maxEp,10):null,
    link: link||null,
    category: currentCategory,
    notes:""
  };
  await addDoc(getMediaCollectionRef(), newItem);
  document.getElementById('cim-input').value="";
  document.getElementById('max-epizod-input').value="";
  document.getElementById('link-input').value="";
};

window.deleteItem = async id => { await deleteDoc(doc(getMediaCollectionRef(), id)); };
window.updateStatus = async (id, st) => { await updateDoc(doc(getMediaCollectionRef(), id), {statusz:st}); };

window.changeEpisodeCount = async (id, delta) => {
  const item = trackerList.find(i=>i.firestoreId===id);
  if (!item || item.tipus!=="sorozat") return;
  let newCount=(item.watchedEpisodes??0)+delta;
  newCount=Math.max(0,newCount);
  if(item.maxEpisodes) newCount=Math.min(newCount,item.maxEpisodes);
  let newStatus=item.statusz;
  if(item.maxEpisodes && newCount===item.maxEpisodes) newStatus="megnÃ©zve";
  else if(newStatus==="megnÃ©zve" && item.maxEpisodes && newCount<item.maxEpisodes) newStatus="nÃ©zendÅ‘";
  await updateDoc(doc(getMediaCollectionRef(),id),{watchedEpisodes:newCount,statusz:newStatus});
};

// --- SzerkesztÃ©s ---
window.toggleEditMode = function(id){
  const editBtn=document.getElementById(`edit-btn-${id}`);
  const saveBtn=document.getElementById(`save-btn-${id}`);
  const cancelBtn=document.getElementById(`cancel-btn-${id}`);
  const titleDisplay=document.getElementById(`title-display-${id}`);
  const titleInput=document.getElementById(`title-edit-${id}`);
  const linkDisplay=document.getElementById(`link-display-${id}`);
  const linkInput=document.getElementById(`link-edit-${id}`);
  const episodesDisplay=document.getElementById(`episodes-display-${id}`);
  const episodesInput=document.getElementById(`episodes-edit-${id}`);
  const isEditing=editBtn.style.display==="none";
  if(!isEditing){
    if(titleDisplay) titleDisplay.style.display="none";
    if(titleInput) titleInput.style.display="inline-block";
    if(linkDisplay) linkDisplay.style.display="none";
    if(linkInput) linkInput.style.display="inline-block";
    if(episodesDisplay) episodesDisplay.style.display="none";
    if(episodesInput) episodesInput.style.display="inline-block";
    editBtn.style.display="none"; saveBtn.style.display="inline-block"; cancelBtn.style.display="inline-block";
  } else {
    if(titleDisplay) titleDisplay.style.display="inline-block";
    if(titleInput) titleInput.style.display="none";
    if(linkDisplay) linkDisplay.style.display="inline-block";
    if(linkInput) linkInput.style.display="none";
    if(episodesDisplay) episodesDisplay.style.display="inline-block";
    if(episodesInput) episodesInput.style.display="none";
    editBtn.style.display="inline-block"; saveBtn.style.display="none"; cancelBtn.style.display="none";
  }
};

window.saveItemDetails = async function(id){
  const titleInput=document.getElementById(`title-edit-${id}`);
  const linkInput=document.getElementById(`link-edit-${id}`);
  const episodesInput=document.getElementById(`episodes-edit-${id}`);
  const updates={};
  if(titleInput){ const t=titleInput.value.trim(); if(t) updates.cim=t; }
  if(linkInput){ const l=linkInput.value.trim(); updates.link=l||null; }
  let newMax=null;
  if(episodesInput){ const p=parseInt(episodesInput.value,10); if(!isNaN(p)&&p>=0){updates.maxEpisodes=p; newMax=p;} }
  const item=trackerList.find(i=>i.firestoreId===id);
  if(item && item.tipus==="sorozat" && newMax!==null){
    const watched=item.watchedEpisodes??0;
    const corrected=Math.min(watched,newMax);
    updates.watchedEpisodes=corrected;
    updates.statusz=(newMax>0 && corrected===newMax)?"megnÃ©zve":"nÃ©zendÅ‘";
  }
  await updateDoc(doc(getMediaCollectionRef(),id),updates);
  toggleEditMode(id);
};

// --- Render ---
function renderLists(){
  const nezendoUl=document.getElementById("nezendo-lista");
  const megnezveUl=document.getElementById("megnezve-lista");
  nezendoUl.innerHTML=""; megnezveUl.innerHTML="";
  const filtered=trackerList.filter(i=>(i.category||"joint")===currentCategory).sort((a,b)=>a.cim.localeCompare(b.cim));
  filtered.forEach(item=>{
    const li=document.createElement("li");
    li.className=`tracker-item ${item.statusz==="megnÃ©zve"?"watched":""}`;
    const details=document.createElement("div"); details.className="item-details";
    const row=document.createElement("div"); row.className="item-title-row";
    const title=document.createElement("strong"); title.id=`title-display-${item.firestoreId}`; title.textContent=item.cim;
    const titleInput=document.createElement("input"); titleInput.id=`title-edit-${item.firestoreId}`; titleInput.className="title-edit-input"; titleInput.value=item.cim;
    const editBtn=document.createElement("button"); editBtn.id=`edit-btn-${item.firestoreId}`; editBtn.textContent="âœï¸ SzerkesztÃ©s"; editBtn.onclick=()=>toggleEditMode(item.firestoreId);
    const saveBtn=document.createElement("button"); saveBtn.id=`save-btn-${item.firestoreId}`; saveBtn.className="save-button"; saveBtn.style.display="none"; saveBtn.textContent="ğŸ’¾ MentÃ©s"; saveBtn.onclick=()=>saveItemDetails(item.firestoreId);
    const cancelBtn=document.createElement("button"); cancelBtn.id=`cancel-btn-${item.firestoreId}`; cancelBtn.className="cancel-button"; cancelBtn.style.display="none"; cancelBtn.textContent="âŒ MÃ©gse"; cancelBtn.onclick=()=>toggleEditMode(item.firestoreId);
    row.append(title,titleInput,editBtn,saveBtn,cancelBtn); details.appendChild(row);
    const typeSpan=document.createElement("span"); typeSpan.textContent=`(${item.tipus==="sorozat"?"Sorozat":"Film"})`; details.appendChild(typeSpan);
    const linkDisplay=document.createElement(item.link?"a":"span"); linkDisplay.id=`link-display-${item
