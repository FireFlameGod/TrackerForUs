<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Media Tracker</title>
<style>
  /* Egyszer≈± st√≠lusok, k√©rlek, ig√©nyeid szerint m√≥dos√≠tsd */
  body { font-family: Arial, sans-serif; margin: 20px; }
  #loading-screen { display: flex; justify-content: center; align-items: center; height: 100vh; }
  #app-content-container { display: none; }
  .list-item { margin-bottom: 10px; }
  .hidden { display: none; }
  .title-display { font-weight: bold; }
  .title-edit-input { width: 200px; }
  .button { margin-left: 5px; }
</style>
</head>
<body>

<!-- Bejelentkez√©si fel√ºlet -->
<div id="login-screen" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
  <h2>K√©rlek, add meg a titkos kulcsot</h2>
  <input type="password" id="access-key-input" placeholder="Kulcs" />
  <button onclick="checkAccessKey()">Bejelentkez√©s</button>
  <div id="login-error" style="color: red; margin-top: 10px;"></div>
</div>

<!-- F≈ë tartalom -->
<div id="main-app-content" style="display: none;">
  <button onclick="logout()">Kijelentkez√©s</button>
  <h3>Megosztott azonos√≠t√≥: <strong id="shared-id-info"></strong></h3>
  <h3>Saj√°t azonos√≠t√≥d: <strong id="user-id-info"></strong></h3>

  <button onclick="toggleAdvancedInfo()">R√©szletek <span id="toggle-icon">‚ñº</span></button>
  <div id="advanced-info-content" style="display: none;">
    <p>Ez az alkalmaz√°s seg√≠t a m√©dia elemek nyilv√°ntart√°s√°ban.</p>
  </div>

  <h2>√öj elem hozz√°ad√°sa</h2>
  <input type="text" id="cim-input" placeholder="C√≠m" />
  <select id="tipus-select">
    <option value="film">Film</option>
    <option value="sorozat">Sorozat</option>
  </select>
  <input type="number" id="max-epizod-input" placeholder="Max epiz√≥d" />
  <input type="text" id="link-input" placeholder="Link" />
  <button onclick="addNewItem()">Hozz√°ad√°s</button>

  <h2>Lista</h2>
  <div id="list-container"></div>
</div>

<!-- Bet√∂lt√©si k√©perny≈ë -->
<div id="loading-screen" style="display: flex;">Bet√∂lt√©s...</div>

<script type="module">
  // Firebase √©s egy√©b szkriptjeid ide j√∂nnek
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAKEKZzgKSTFQ3_K6Yhm7aPvTX5plMzXYg",
    authDomain: "tracker-fbe21.firebaseapp.com",
    projectId: "tracker-fbe21",
    storageBucket: "tracker-fbe21.appspot.com",
    messagingSenderId: "402979419538",
    appId: "1:402979419538:web:ff7924c73c306ff8527d4b"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app); 
  
  const ENCODED_ACCESS_KEY = "MDAxMw=="; 
  const ACCESS_KEY_LOCAL_STORAGE = "trackerAccessGranted";
  const SHARED_UID = "SHARED_FRIENDS_GROUP"; 

  let trackerList = [];
  let gameList = [];    

  const THEME_COLOR_KEY = 'trackerThemeColor';
  const DEFAULT_COLOR = '#ff8c00'; 
  const MEDIA_COLLECTION_NAME = 'media';
  const GAME_COLLECTION_NAME = 'games';

  let currentCategory = 'joint'; 
  const CATEGORY_MAP = {
    'joint': 'üßë‚Äçü§ù‚Äçüßë K√∂z√∂s n√©z√©s', 
    'cdrama': 'üá®üá≥ C-Drama',
    'kdrama': 'üá∞üá∑ K-Drama',
    'anime': 'üáØüáµ Anime',
    'donghua': 'üéé Donghua',
    'other': 'üåç Egy√©b',
  };
  const CATEGORIES = Object.keys(CATEGORY_MAP); 

  window.checkAccessKey = function() {
    const inputKey = document.getElementById('access-key-input').value.trim();
    const errorDiv = document.getElementById('login-error');
    const SECRET_ACCESS_KEY = atob(ENCODED_ACCESS_KEY);

    if (inputKey === SECRET_ACCESS_KEY) {
      localStorage.setItem(ACCESS_KEY_LOCAL_STORAGE, 'true');
      errorDiv.textContent = '';
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app-content').style.display = 'block';
      initAuthAndApp(); 
    } else {
      errorDiv.textContent = 'Hib√°s titkos kulcs!';
      localStorage.removeItem(ACCESS_KEY_LOCAL_STORAGE);
    }
  }
  
  function checkInitialAccess() {
    if (localStorage.getItem(ACCESS_KEY_LOCAL_STORAGE) === 'true') {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app-content').style.display = 'block';
      initAuthAndApp();
    } else {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app-content').style.display = 'none';
    }
  }
  
  window.logout = function() {
    localStorage.removeItem(ACCESS_KEY_LOCAL_STORAGE);
    window.location.reload(); 
  }
  
  window.toggleAdvancedInfo = function() {
    const content = document.getElementById('advanced-info-content');
    const icon = document.getElementById('toggle-icon');
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    icon.textContent = isHidden ? '‚ñ≤' : '‚ñº';
  }

  function getMediaCollectionRef() {
    return collection(db, 'users', SHARED_UID, MEDIA_COLLECTION_NAME);
  }
  function getGameCollectionRef() {
    return collection(db, 'users', SHARED_UID, GAME_COLLECTION_NAME);
  }

  async function initAuthAndApp() {
    try {
      const userCredential = await signInAnonymously(auth);
      const actualUserId = userCredential.user.uid;
      document.getElementById('shared-id-info').querySelector('strong').textContent = SHARED_UID;
      document.getElementById('user-id-info').querySelector('strong').textContent = actualUserId;

      loadThemeColor();
      startFirestoreListeners();
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('app-content-container').style.display = 'block';

      showMainTab('media');

    } catch (error) {
      console.error("Azonos√≠t√°si hiba:", error);
      document.getElementById('shared-id-info').querySelector('strong').textContent = "HIBA: Ellen≈ërizze a konzolt!";
      document.getElementById('user-id-info').querySelector('strong').textContent = `Auth hiba: ${error.message}`;
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('app-content-container').style.display = 'block';
    }
  }

  function startFirestoreListeners() {
    onSnapshot(getMediaCollectionRef(), (snapshot) => {
      trackerList = snapshot.docs.map(doc => ({
        firestoreId: doc.id,
        category: doc.data().category || 'joint',
        notes: doc.data().notes || '',
        ...doc.data()
      }));
      renderLists();
    }, (error) => {
      console.error("Hiba a media lista lek√©r√©sekor: ", error);
    });

    onSnapshot(getGameCollectionRef(), (snapshot) => {
      gameList = snapshot.docs.map(doc => ({
        firestoreId: doc.id,
        ...doc.data()
      }));
      renderGameLists();
    }, (error) => {
      console.error("Hiba a j√°t√©k lista lek√©r√©sekor: ", error);
    });
  }

  window.addNewItem = async function() {
    const cim = document.getElementById('cim-input').value.trim();
    const tipus = document.getElementById('tipus-select').value;
    const maxEpizodInput = document.getElementById('max-epizod-input').value;
    const linkInput = document.getElementById('link-input').value.trim();
    
    if (cim === "") { return; }
    
    const newItem = {
      cim: cim,
      tipus: tipus,
      statusz: "n√©zend≈ë",
      watchedEpisodes: (tipus === 'sorozat' ? 0 : null),
      maxEpisodes: (tipus === 'sorozat' && maxEpizodInput ? parseInt(maxEpizodInput) : null),
      link: (linkInput || null),
      category: currentCategory,
      notes: ""
    };

    try {
      await addDoc(getMediaCollectionRef(), newItem); 
    } catch (e) {
      console.error("Kritikus hiba az elem hozz√°ad√°sakor: ", e);
    }
    document.getElementById('cim-input').value = '';
    document.getElementById('max-epizod-input').value = '';
    document.getElementById('link-input').value = '';
  }

  window.deleteItem = async function(firestoreId) {
    try {
      await deleteDoc(doc(getMediaCollectionRef(), firestoreId));
    } catch (e) {
      console.error("Hiba az elem t√∂rl√©sekor: ", e);
    }
  }
  
  window.updateStatus = async function(firestoreId, newStatus) {
    try {
      await updateDoc(doc(getMediaCollectionRef(), firestoreId), {
        statusz: newStatus
      });
    } catch (e) {
      console.error("Hiba a st√°tusz friss√≠t√©sekor: ", e);
    }
  }

  window.changeEpisodeCount = async function(firestoreId, delta) {
    const item = trackerList.find(item => item.firestoreId === firestoreId);
    if (item && item.tipus === 'sorozat') {
      let newCount = item.watchedEpisodes + delta;
      newCount = Math.max(0, newCount);
      if (item.maxEpisodes !== null && item.maxEpisodes > 0) {
        newCount = Math.min(newCount, item.maxEpisodes);
      }
      let newStatus = item.statusz;
      if (item.maxEpisodes !== null && item.maxEpisodes > 0 && newCount === item.maxEpisodes) {
        newStatus = 'megn√©zve';
      } else if (newStatus === 'megn√©zve' && newCount < item.maxEpisodes) {
        newStatus = 'n√©zend≈ë'; 
      }
      try {
        await updateDoc(doc(getMediaCollectionRef(), firestoreId), {
          watchedEpisodes: newCount,
          statusz: newStatus
        });
      } catch (e) {
        console.error("Hiba az epiz√≥d friss√≠t√©sekor: ", e);
      }
    }
  }

  // √öj ment≈ë f√ºggv√©ny, ami a c√≠m, link √©s epiz√≥d sz√°mot is friss√≠ti
  window.saveItemDetails = async function(firestoreId) {
    const titleDisplay = document.getElementById(`title-display-${firestoreId}`);
    const linkInput = document.getElementById(`link-edit-${firestoreId}`);
    const episodesInput = document.getElementById(`episode-edit-${firestoreId}`);

    if (!titleDisplay || !linkInput || !episodesInput) { return; }

    const newTitle = titleDisplay.textContent.trim();
    const newLink = linkInput.value.trim();
    const newWatchedEpisodes = parseInt(episodesInput.value);

    try {
      await updateDoc(doc(getMediaCollectionRef(), firestoreId), {
        cim: newTitle,
        link: newLink || null,
        watchedEpisodes: isNaN(newWatchedEpisodes) ? 0 : newWatchedEpisodes
      });
    } catch (e) {
      console.error("Hiba a m√≥dos√≠t√°skor: ", e);
    }
  }

  window.toggleEditMode = function(firestoreId) {
    const display = document.getElementById(`title-display-${firestoreId}`);
    const input = document.getElementById(`title-edit-${firestoreId}`);
    const linkInput = document.getElementById(`link-edit-${firestoreId}`);
    const episodeInput = document.getElementById(`episode-edit-${firestoreId}`);
    const editBtn = document.getElementById(`edit-btn-${firestoreId}`);
    const saveBtn = document.getElementById(`save-btn-${firestoreId}`);
    const cancelBtn = document.getElementById(`cancel-btn-${firestoreId}`);
    
    if (!display || !input || !linkInput || !episodeInput || !editBtn || !saveBtn || !cancelBtn) { return; } 

    const isEditing = display.style.display === 'none';

    if (!isEditing) {
      // Szerkeszt√©si m√≥d enged√©lyez√©se
      display.style.display = 'none';
      input.style.display = 'inline-block';
      linkInput.style.display = 'inline-block';
      episodeInput.style.display = 'inline-block';

      // √©rt√©kek be√°ll√≠t√°sa
      input.value = display.textContent.trim();
      linkInput.value = linkInput.value || '';
      // a watchedEpisodes √©rt√©k
      const currentItem = trackerList.find(item => item.firestoreId === firestoreId);
      if (currentItem) {
        episodeInput.value = currentItem.watchedEpisodes !== null ? currentItem.watchedEpisodes : '';
      }

      // Gombok
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';

      episodeInput.focus();
      const len = episodeInput.value.length;
      episodeInput.setSelectionRange(len, len);
    } else {
      // Kikapcsoljuk szerkeszt√©st
      display.style.display = 'inline-block';
      input.style.display = 'none';
      linkInput.style.display = 'none';
      episodeInput.style.display = 'none';

      // Gombok
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
    }
  }

  // A t√∂bbi marad v√°ltozatlan...
  // (itt √≠rhatod a renderLists √©s renderGameLists f√ºggv√©nyeket, stb.)

  // Itt a lista renderel√©se, ahol minden elemhez hozz√°adod a szerkeszt√©se lehet≈ës√©g√©t
  function renderLists() {
    const container = document.getElementById('list-container');
    container.innerHTML = '';

    trackerList.forEach(item => {
      const div = document.createElement('div');
      div.className = 'list-item';

      // C√≠m megjelen√≠t√©se
      const titleSpan = document.createElement('span');
      titleSpan.id = `title-display-${item.firestoreId}`;
      titleSpan.className = 'title-display';
      titleSpan.textContent = item.cim;

      // Szerkeszt√©s gomb
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Szerkeszt√©s';
      editBtn.className = 'button';
      editBtn.id = `edit-btn-${item.firestoreId}`;
      editBtn.onclick = () => toggleEditMode(item.firestoreId);

      // Ment√©s gomb
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Ment√©s';
      saveBtn.className = 'button';
      saveBtn.id = `save-btn-${item.firestoreId}`;
      saveBtn.style.display = 'none';
      saveBtn.onclick = () => saveItemDetails(item.firestoreId);

      // M√©gse gomb
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'M√©gse';
      cancelBtn.className = 'button';
      cancelBtn.id = `cancel-btn-${item.firestoreId}`;
      cancelBtn.style.display = 'none';
      cancelBtn.onclick = () => toggleEditMode(item.firestoreId);

      // Link szerkeszt≈ë mez≈ë
      const linkInput = document.createElement('input');
      linkInput.type = 'url';
      linkInput.id = `link-edit-${item.firestoreId}`;
      linkInput.className = 'title-edit-input';
      linkInput.style.display = 'none';

      // Epiz√≥d szerkeszt≈ë mez≈ë
      const episodeInput = document.createElement('input');
      episodeInput.type = 'number';
      episodeInput.id = `episode-edit-${item.firestoreId}`;
      episodeInput.className = 'title-edit-input';
      episodeInput.style.display = 'none';

      // Az elem √∂sszerak√°sa
      div.appendChild(titleSpan);
      div.appendChild(editBtn);
      div.appendChild(saveBtn);
      div.appendChild(cancelBtn);
      div.appendChild(document.createTextNode(' Link: '));
      div.appendChild(linkInput);
      div.appendChild(document.createTextNode(' Epiz√≥dok: '));
      div.appendChild(episodeInput);
      
      // Tov√°bbi mez≈ëk, gombok, stb. hozz√°ad√°sa ide

      container.appendChild(div);
    });
  }

  // A funkci√≥kat ide √≠rhatod, illetve a renderGameLists stb.

  // Ellen≈ërz√©s
  checkInitialAccess();

</script>

</body>
</html>
