<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracker</title>
    <!-- Be√°gyazott CSS st√≠lusok -->
    <style>
        :root {
            --theme-color: #ff8c00; 
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; 
            background-color: #1e1e1e;
            color: #f0f0f0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 100vh; 
        }

        .container {
            width: 100%;
            max-width: 1500px; 
            background-color: #282828;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        /* --- BEL√âPTET≈ê K√âPERNY≈ê ST√çLUSOK --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1e1e1e;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .login-box {
            background: #333;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.7);
        }

        .login-box button {
            background-color: var(--theme-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
        }

        .login-box button:hover {
            background-color: #cc7000;
        }
        
        /* --- FEL√úLET ST√çLUSOK --- */
        header {
            border-bottom: 2px solid var(--theme-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--theme-color);
            font-size: 2em;
            margin: 0;
        }

        /* Input √©s Gomb St√≠lusok */
        input[type="text"], textarea, input[type="number"] {
            background-color: #333;
            border: 1px solid #444;
            color: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus, input[type="number"]:focus {
            border-color: var(--theme-color);
            outline: none;
        }

        .add-button {
            background-color: var(--theme-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            transition: background-color 0.3s;
        }

        .add-button:hover {
            background-color: #cc7000;
        }

        /* Lista St√≠lusok */
        .list-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .list-section {
            flex: 1;
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .list-section h2 {
            color: var(--theme-color);
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .media-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .media-item {
            display: flex;
            flex-direction: column;
            background-color: #3a3a3a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
            border-left: 5px solid var(--theme-color);
            transition: transform 0.2s;
        }

        .media-item:hover {
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .item-title-display {
            font-weight: bold;
            font-size: 1.1em;
            color: #fff;
            flex-grow: 1;
        }

        /* √öJ: Szerkeszt√©si mez≈ëk st√≠lusa */
        .edit-fields-container {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #444;
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 15px;
        }

        .media-item.editing-title .edit-fields-container {
            display: grid;
        }
        
        .edit-fields-container label {
            display: block;
            font-size: 0.9em;
            color: #aaa;
            margin-bottom: 3px;
        }
        
        /* A Link √©s epiz√≥d megjelen√≠t√©s */
        .item-metadata {
            font-size: 0.8em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .item-metadata a {
            color: #87ceeb; /* Vil√°gos k√©k a linkekhez */
            text-decoration: none;
        }

        .item-notes {
            margin-top: 10px;
            padding: 8px;
            background-color: #444;
            border-radius: 4px;
            border-left: 3px solid #666;
            white-space: pre-wrap;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-button {
            background: none;
            border: none;
            color: var(--theme-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }

        .action-button:hover {
            background-color: #555;
            color: #fff;
        }

        .status-toggle-button {
            background-color: #4CAF50; /* Z√∂ld */
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        
        .status-toggle-button[data-status="j√°tszand√≥"] {
            background-color: #007bff; /* K√©k */
        }
        
        .status-toggle-button[data-status="megnezve"] {
            background-color: #4CAF50; /* Z√∂ld */
        }
        
        /* Reszponzivit√°s */
        @media (max-width: 1000px) {
            .list-container {
                flex-direction: column;
            }
        }
        
        @media (max-width: 600px) {
            .edit-fields-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Bel√©ptet≈ë k√©perny≈ë (Loading/Authentik√°ci√≥) -->
    <div id="login-screen">
        <div class="login-box">
            <h2 id="login-message" style="color:white;">Csatlakoz√°s a Firebase-hez...</h2>
            <p style="font-size: 0.8em; color: #aaa;">K√©rj√ºk, v√°rjon. A rendszer inicializ√°lja az azonos√≠t√≥j√°t.</p>
            <p id="timeout-message" style="font-size: 0.7em; color: yellow; display: none; margin-top: 15px;">
                Ha ez a k√©perny≈ë hossz√∫ ideig l√°that√≥, el≈ëfordulhat, hogy a Firebase konfigur√°ci√≥ hi√°nyzik.
            </p>
        </div>
    </div>
    
    <!-- F≈ë alkalmaz√°s kont√©ner -->
    <div id="app-container" class="container hidden">
        <header>
            <div>
                <h1>M√©dia K√∂vet≈ë</h1>
                <p style="font-size: 0.8em; color: #aaa; margin-top: 5px;">Azonos√≠t√≥: <span id="user-id-display"></span></p>
            </div>
            <p id="auth-status" style="font-size: 0.9em; color: #ccc;">Offline</p>
        </header>

        <!-- Keres√©s -->
        <div class="search-section" style="margin-bottom: 20px;">
            <input type="text" id="search-input" placeholder="Keres√©s c√≠m alapj√°n..." style="width: 100%;" />
        </div>

        <!-- √öj elem hozz√°ad√°sa -->
        <div class="add-new-section" style="margin-bottom: 20px;">
            <input type="text" id="media-title-input" placeholder="M√©dia c√≠me (pl. sorozat, film, j√°t√©k)" maxlength="200" />
            <button id="add-media-button" class="add-button">Hozz√°ad√°s a J√°tszand√≥ list√°hoz</button>
        </div>

        <!-- Lista kont√©nerek -->
        <div class="list-container">
            <!-- J√°tszand√≥ / N√©zend≈ë lista -->
            <div class="list-section">
                <h2>J√°tszand√≥ / N√©zend≈ë</h2>
                <ul id="nezendo-ul" class="media-list">
                    <!-- Dinamikus tartalom -->
                </ul>
                <p id="nezendo-empty-message" style="color:#888; text-align:center;">Nincs megjelen√≠thet≈ë elem.</p>
            </div>
            
            <!-- Megn√©zve / K√©sz lista -->
            <div class="list-section">
                <h2>Megn√©zve / K√©sz</h2>
                <ul id="megnezve-ul" class="media-list">
                    <!-- Dinamikus tartalom -->
                </ul>
                <p id="megnezve-empty-message" style="color:#888; text-align:center;">Nincs megjelen√≠thet≈ë elem.</p>
            </div>
        </div>

        <!-- Hiba√ºzenet kijelz≈ë -->
        <div id="error-message" style="color: red; margin-top: 20px; background: #550000; padding: 10px; border-radius: 8px; display: none;">
            Hiba t√∂rt√©nt: <span id="error-text"></span>
        </div>

        <!-- Egyedi Modal az Alert helyett -->
        <div id="custom-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;">
            <div style="background: #282828; padding: 25px; border-radius: 10px; max-width: 400px; width: 90%; box-shadow: 0 5px 25px rgba(0,0,0,0.8);">
                <h3 style="color: var(--theme-color); margin-top: 0;" id="modal-title"></h3>
                <p id="modal-body" style="color: #f0f0f0; margin-bottom: 20px;"></p>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="modal-cancel-btn" class="add-button" style="background-color: #666; width: auto;">M√©gse</button>
                    <button id="modal-confirm-btn" class="add-button" style="width: auto;">T√∂rl√©s meger≈ës√≠t√©se</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === GLOB√ÅLIS V√ÅLTOZ√ìK √âS KONFIGUR√ÅCI√ì MEGER≈êS√çT√âSE ===
        // Ellen≈ërizz√ºk a glob√°lis v√°ltoz√≥k el√©rhet≈ës√©g√©t, amit a Canvas k√∂rnyezet biztos√≠t.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // A konfigur√°ci√≥t JSON-b√≥l olvassuk be, ha el√©rhet≈ë
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let allMediaItems = []; 
        let currentEditingId = null; 
        let currentNotesEditingId = null; 

        // DOM elemek gyors el√©r√©se
        const loginScreen = document.getElementById('login-screen');
        const loginMessage = document.getElementById('login-message');
        const timeoutMessage = document.getElementById('timeout-message');
        const appContainer = document.getElementById('app-container');
        const authStatus = document.getElementById('auth-status');
        const userIdDisplay = document.getElementById('user-id-display');
        const errorText = document.getElementById('error-text');
        const errorMessageDiv = document.getElementById('error-message');
        
        const searchInput = document.getElementById('search-input'); 
        const mediaTitleInput = document.getElementById('media-title-input');
        const addMediaButton = document.getElementById('add-media-button');
        const nezendoUl = document.getElementById('nezendo-ul');
        const megnezveUl = document.getElementById('megnezve-ul');
        const nezendoEmptyMessage = document.getElementById('nezendo-empty-message');
        const megnezveEmptyMessage = document.getElementById('megnezve-empty-message');
        
        // Modal elemek
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');


        // === SEG√âDF√úGGV√âNYEK ===

        // Hiba√ºzenet megjelen√≠t√©se a fel√ºleten
        function displayError(message) {
            console.error("APP HIBA:", message);
            errorText.textContent = message;
            errorMessageDiv.style.display = 'block';
            authStatus.textContent = 'Hiba! L√°sd a konzolt.';
        }
        
        // Egyedi Modal Megjelen√≠t√©se
        function showModal(title, body, confirmAction) {
            modalTitle.textContent = title;
            modalBody.textContent = body;
            customModal.style.display = 'flex';

            modalConfirmBtn.onclick = null; 
            modalCancelBtn.onclick = null;

            modalConfirmBtn.onclick = () => {
                customModal.style.display = 'none';
                confirmAction();
            };

            modalCancelBtn.onclick = () => {
                customModal.style.display = 'none';
            };
        }

        // === FIREBASE M≈∞VELETEK ===

        async function initializeFirebase() {
            // Hi√°nyz√≥ konfigur√°ci√≥ ellen≈ërz√©se
            if (!firebaseConfig) {
                const errorMsg = 'Hi√°nyzik a Firebase konfigur√°ci√≥. K√©rem, friss√≠tse a Canvas k√∂rnyezetet.';
                displayError(errorMsg);
                loginMessage.textContent = errorMsg;
                timeoutMessage.style.display = 'block';
                return;
            }

            try {
                setLogLevel('Debug');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Megjelen√≠tj√ºk a bet√∂lt≈ë k√©perny≈ët
                loginScreen.style.display = 'flex';
                
                // Id≈ëz√≠t≈ë a konfigur√°ci√≥ hi√°ny√°nak jelz√©s√©re (ha hossz√∫ ideig tart a bejelentkez√©s)
                setTimeout(() => {
                    if (!userId) {
                        timeoutMessage.style.display = 'block';
                    }
                }, 5000); 

                // Autentik√°ci√≥
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Autentik√°ci√≥s √°llapot figyel√©se
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authStatus.textContent = 'Online';
                        loginScreen.style.display = 'none';
                        appContainer.classList.remove('hidden');
                        setupRealtimeListener(); // Val√≥s idej≈± figyel≈ë ind√≠t√°sa
                        
                        // Keres√©s esem√©nyfigyel≈ë hozz√°ad√°sa
                        searchInput.addEventListener('input', filterAndDisplay); 

                    } else {
                        userId = null;
                        authStatus.textContent = 'Offline';
                        loginMessage.textContent = 'Nincs azonos√≠tva.';
                    }
                });

                // Esem√©nyfigyel≈ë az √∫j elem gombra
                addMediaButton.addEventListener('click', addNewMedia);
                
            } catch (error) {
                displayError(`Inicializ√°l√°si hiba: ${error.message}`);
                loginMessage.textContent = 'Hiba az inicializ√°l√°sban.';
            }
        }

        // √öj elem hozz√°ad√°sa a Firestore-hoz
        async function addNewMedia() {
            if (!db || !userId) {
                displayError("Az adatb√°zis nem √°ll k√©szen.");
                return;
            }

            const title = mediaTitleInput.value.trim();
            if (title === "") {
                mediaTitleInput.placeholder = "K√©rem, adja meg a c√≠met!";
                return;
            }
            
            addMediaButton.disabled = true;
            addMediaButton.textContent = 'Ment√©s...';

            try {
                const collectionPath = `artifacts/${appId}/users/${userId}/media_tracker`;
                const mediaCollectionRef = collection(db, collectionPath);

                await addDoc(mediaCollectionRef, {
                    title: title,
                    statusz: 'j√°tszand√≥', // Alap√©rtelmezett √°llapot
                    notes: '',
                    link: '', 
                    epiz√≥d: 0, 
                    hozzaadva: serverTimestamp()
                });

                mediaTitleInput.value = '';
            } catch (error) {
                displayError(`Hiba a m√©dia hozz√°ad√°sakor: ${error.message}`);
            } finally {
                addMediaButton.disabled = false;
                addMediaButton.textContent = 'Hozz√°ad√°s a J√°tszand√≥ list√°hoz';
            }
        }
        
        // Elem t√∂rl√©se
        async function deleteMedia(firestoreId) {
            if (!db || !userId) return;

            showModal(
                "T√∂rl√©s meger≈ës√≠t√©se", 
                "Biztos benne, hogy v√©glegesen t√∂rli ezt az elemet a k√∂vet≈ëlist√°j√°r√≥l?", 
                async () => {
                    try {
                        const docPath = `artifacts/${appId}/users/${userId}/media_tracker/${firestoreId}`;
                        await deleteDoc(doc(db, docPath));
                    } catch (error) {
                        displayError(`Hiba a m√©dia t√∂rl√©sekor: ${error.message}`);
                    }
                }
            );
        }

        // √Ållapot (Statusz) v√°lt√°sa
        async function toggleStatus(firestoreId, currentStatus) {
            if (!db || !userId) return;
            const newStatus = currentStatus === 'j√°tszand√≥' ? 'megnezve' : 'j√°tszand√≥';
            
            try {
                const docPath = `artifacts/${appId}/users/${userId}/media_tracker/${firestoreId}`;
                await updateDoc(doc(db, docPath), {
                    statusz: newStatus
                });
            } catch (error) {
                displayError(`Hiba az √°llapot v√°lt√°sakor: ${error.message}`);
            }
        }

        // C√≠m, link √©s epiz√≥d szerkeszt√©se: √öj adatok ment√©se
        async function saveNewTitle(firestoreId) {
            if (!db || !userId) return;
            
            const li = document.querySelector(`.media-item[data-id="${firestoreId}"]`);
            // Lek√©rdezz√ºk az √∂sszes szerkesztend≈ë mez≈ë √©rt√©k√©t
            const newTitle = li.querySelector('input[data-field="title"]').value.trim();
            const newLink = li.querySelector('input[data-field="link"]').value.trim();
            const newEpisodeValue = li.querySelector('input[data-field="episode"]').value.trim();
            const newEpisode = parseInt(newEpisodeValue, 10);
            
            if (newTitle === "") {
                li.querySelector('input[data-field="title"]').value = "C√≠m megad√°sa k√∂telez≈ë!";
                return;
            }

            try {
                const docPath = `artifacts/${appId}/users/${userId}/media_tracker/${firestoreId}`;
                
                const updateData = {
                    title: newTitle,
                    link: newLink,
                    epiz√≥d: isNaN(newEpisode) || newEpisode < 0 ? 0 : newEpisode 
                };

                await updateDoc(doc(db, docPath), updateData);
                toggleEditMode(firestoreId); // Vissza√°ll√≠t√°s megjelen√≠t√©si m√≥dba
            } catch (error) {
                displayError(`Hiba a c√≠m/link/epiz√≥d ment√©sekor: ${error.message}`);
            }
        }

        // Megjegyz√©s szerkeszt√©se: √öj jegyzet ment√©se
        async function saveNotes(firestoreId) {
            if (!db || !userId) return;
            
            const li = document.querySelector(`.media-item[data-id="${firestoreId}"]`);
            const textarea = li.querySelector('textarea[data-field="notes"]');
            const newNotes = textarea.value.trim();

            try {
                const docPath = `artifacts/${appId}/users/${userId}/media_tracker/${firestoreId}`;
                await updateDoc(doc(db, docPath), {
                    notes: newNotes
                });
                toggleNotesEditMode(firestoreId); // Vissza√°ll√≠t√°s megjelen√≠t√©si m√≥dba
            } catch (error) {
                displayError(`Hiba a jegyzet ment√©sekor: ${error.message}`);
            }
        }

        // === UI V√ÅLT√ÅSOK √âS MEGJELEN√çT√âS ===

        // C√≠m, link, epiz√≥d szerkeszt√©si m√≥d ki/be kapcsol√°sa
        function toggleEditMode(firestoreId) {
            // Megkeress√ºk a szerkesztett elemet
            const li = document.querySelector(`.media-item[data-id="${firestoreId}"]`);
            if (!li) return;
            
            const titleSpan = li.querySelector('.item-title-display');
            const editButton = li.querySelector('button[data-action="edit-media"]');
            const saveButton = li.querySelector('button[data-action="save-media"]');
            const cancelButton = li.querySelector('button[data-action="cancel-media"]');
            const statusButton = li.querySelector('.status-toggle-button');
            const metadataDiv = li.querySelector('.item-metadata');
            const editFieldsContainer = li.querySelector('.edit-fields-container');
            
            // Az "editing-title" oszt√°ly hozz√°ad√°sa/elt√°vol√≠t√°sa v√°ltja a m√≥dot
            const isEditing = li.classList.toggle('editing-title');

            if (isEditing) {
                // Elmentj√ºk a jelenlegi √°llapotot
                const currentItem = allMediaItems.find(item => item.id === firestoreId) || {};

                // Title helyettes√≠t√©se input mez≈ëvel
                // Az onSnapshot √∫jraind√≠tja a megjelen√≠t√©st, ez√©rt a szerkeszt√©si m√≥dot az oszt√°lyon kereszt√ºl kell fenntartani.
                titleSpan.innerHTML = `<input type="text" data-field="title" value="${currentItem.title || ''}" style="margin: 0; padding: 5px; width: 100%;" maxlength="200" />`;
                titleSpan.querySelector('input').focus();
                
                // Kieg√©sz√≠t≈ë mez≈ëk megjelen√≠t√©se
                editFieldsContainer.style.display = 'grid';
                editFieldsContainer.innerHTML = `
                    <div>
                        <label for="edit-link-${firestoreId}">Link (URL):</label>
                        <input type="text" id="edit-link-${firestoreId}" data-field="link" value="${currentItem.link || ''}" placeholder="Opcion√°lis link" style="margin-bottom: 0;" />
                    </div>
                    <div>
                        <label for="edit-episode-${firestoreId}">Epiz√≥d/Szint:</label>
                        <input type="number" id="edit-episode-${firestoreId}" data-field="episode" value="${currentItem.epiz√≥d || 0}" min="0" style="margin-bottom: 0; text-align: center;" />
                    </div>
                `;

                // Gombok cser√©je
                editButton.style.display = 'none';
                statusButton.style.display = 'none';
                saveButton.style.display = 'inline-block';
                cancelButton.style.display = 'inline-block';
                currentEditingId = firestoreId;

            } else {
                // Vissza√°ll√≠t√°s megjelen√≠t√©si m√≥dba
                editFieldsContainer.style.display = 'none';
                // titleSpan tartalm√°t az onSnapshot friss√≠ti majd
                // Gombok vissza√°ll√≠t√°sa
                editButton.style.display = 'inline-block';
                statusButton.style.display = 'inline-block';
                saveButton.style.display = 'none';
                cancelButton.style.display = 'none';
                currentEditingId = null;
            }
        }

        // Jegyzet szerkeszt√©si m√≥d ki/be kapcsol√°sa
        function toggleNotesEditMode(firestoreId) {
            const li = document.querySelector(`.media-item[data-id="${firestoreId}"]`);
            if (!li) return;

            const notesDiv = li.querySelector('.item-notes');
            const notesText = notesDiv.getAttribute('data-value') || '';
            const editButton = li.querySelector('button[data-action="edit-notes"]');
            const saveButton = li.querySelector('button[data-action="save-notes"]');
            const cancelButton = li.querySelector('button[data-action="cancel-notes"]');

            const isEditing = li.classList.toggle('editing-notes');

            if (isEditing) {
                // √Åtalak√≠t√°s textarea mez≈ëv√©
                notesDiv.innerHTML = `<textarea data-field="notes" style="min-height: 80px; margin: 0; padding: 5px; width: 100%;">${notesText}</textarea>`;
                notesDiv.querySelector('textarea').focus();
                
                // Gombok cser√©je
                editButton.style.display = 'none';
                saveButton.style.display = 'inline-block';
                cancelButton.style.display = 'inline-block';
                currentNotesEditingId = firestoreId;
            } else {
                // Vissza√°ll√≠t√°s div-re (az onSnapshot √∫gyis friss√≠ti az adatokat)
                // Gombok vissza√°ll√≠t√°sa
                editButton.style.display = 'inline-block';
                saveButton.style.display = 'none';
                cancelButton.style.display = 'none';
                currentNotesEditingId = null;
            }
        }
        
        // M√©dia elemek megjelen√≠t√©se a list√°kban
        function displayMediaItems(items) {
            nezendoUl.innerHTML = '';
            megnezveUl.innerHTML = '';

            let nezendoCount = 0;
            let megnezveCount = 0;

            items.forEach(function(item) {
                // Biztos√≠tjuk, hogy a mez≈ëk l√©tezzenek
                item.title = item.title || 'N√©vtelen elem'; 
                item.notes = item.notes || '';
                item.link = item.link || ''; 
                item.epiz√≥d = item.epiz√≥d !== undefined ? item.epiz√≥d : 0; 
                
                const hozzaadvaDate = item.hozzaadva ? new Date(item.hozzaadva.seconds * 1000).toLocaleDateString('hu-HU') : 'Ismeretlen';
                
                const li = document.createElement('li');
                li.className = 'media-item' + (item.id === currentEditingId ? ' editing-title' : '') + (item.id === currentNotesEditingId ? ' editing-notes' : '');
                li.setAttribute('data-id', item.id);
                
                const isTitleEditing = item.id === currentEditingId;
                const isNotesEditing = item.id === currentNotesEditingId;

                // C√≠m megjelen√≠t√©se szerkeszt√©si m√≥dban vagy norm√°l m√≥dban
                const titleDisplay = isTitleEditing 
                    ? `<input type="text" data-field="title" value="${item.title}" style="margin: 0; padding: 5px; width: 100%;" maxlength="200" />`
                    : `<span class="item-title-display" data-value="${item.title}">${item.title}</span>`;

                // Link √©s epiz√≥d megjelen√≠t√©se
                const safeLink = item.link.trim();
                const formattedLink = safeLink.startsWith('http') ? safeLink : (safeLink ? 'http://' + safeLink : '');
                const linkText = safeLink ? `<a href="${formattedLink}" target="_blank" title="Megnyit√°s √∫j lapon">${safeLink}</a>` : 'Nincs megadva';
                const episodeText = item.epiz√≥d > 0 ? `Epiz√≥d/Szint: ${item.epiz√≥d}` : 'Nincs adat';
                
                const metadataContent = `
                    Hozz√°adva: ${hozzaadvaDate} | 
                    Link: ${linkText} | 
                    Epiz√≥d/Szint: ${episodeText}
                `;

                // Jegyzetek megjelen√≠t√©se szerkeszt√©si m√≥dban vagy norm√°l m√≥dban
                const notesDisplay = isNotesEditing
                    ? `<textarea data-field="notes" style="min-height: 80px; margin: 0; padding: 5px; width: 100%;">${item.notes}</textarea>`
                    : `<div class="item-notes" data-value="${item.notes}">${item.notes || 'Nincs megjegyz√©s'}</div>`;

                // Gombok be√°ll√≠t√°sa
                const editTitleBtnStyle = isTitleEditing ? 'display: none;' : '';
                const saveTitleBtnStyle = isTitleEditing ? '' : 'display: none;';
                const cancelTitleBtnStyle = isTitleEditing ? '' : 'display: none;';

                const editNotesBtnStyle = isNotesEditing ? 'display: none;' : '';
                const saveNotesBtnStyle = isNotesEditing ? '' : 'display: none;';
                const cancelNotesBtnStyle = isNotesEditing ? '' : 'display: none;';

                const statusButtonDisplay = isTitleEditing ? 'display: none;' : '';
                
                // --- LI TARTALOM √ñSSZE√ÅLL√çT√ÅSA ---
                li.innerHTML = `
                    <div class="item-header">
                        ${titleDisplay}
                        <div class="action-buttons">
                            <!-- C√≠m/Link/Epiz√≥d Szerkeszt√©s/Ment√©s/M√©gse -->
                            <button class="action-button" data-id="${item.id}" data-action="edit-media" title="C√≠m/Link/Epiz√≥d szerkeszt√©se" style="${editTitleBtnStyle}">‚úé</button>
                            <button class="action-button" data-id="${item.id}" data-action="save-media" title="Ment√©s" style="${saveTitleBtnStyle}">üíæ</button>
                            <button class="action-button" data-id="${item.id}" data-action="cancel-media" title="M√©gse" style="${cancelTitleBtnStyle}">‚úñ</button>
                            
                            <!-- St√°tusz V√°lt√°s -->
                            <button class="status-toggle-button" data-id="${item.id}" data-status="${item.statusz}" data-action="toggle-status" title="St√°tusz v√°lt√°sa" style="${statusButtonDisplay}">
                                ${item.statusz === 'j√°tszand√≥' ? 'K√©sznek jel√∂l' : 'J√°tszand√≥nak jel√∂l'}
                            </button>
                        </div>
                    </div>
                    
                    <!-- √öJ: Szerkeszt√©si mez≈ëk kont√©ner -->
                    <div class="edit-fields-container" style="display: ${isTitleEditing ? 'grid' : 'none'};">
                        <div>
                            <label for="edit-link-${item.id}">Link (URL):</label>
                            <input type="text" id="edit-link-${item.id}" data-field="link" value="${item.link}" placeholder="Opcion√°lis link" style="margin-bottom: 0;" />
                        </div>
                        <div>
                            <label for="edit-episode-${item.id}">Epiz√≥d/Szint:</label>
                            <input type="number" id="edit-episode-${item.id}" data-field="episode" value="${item.epiz√≥d}" min="0" style="margin-bottom: 0; text-align: center;" />
                        </div>
                    </div>

                    <!-- Megjelen√≠tett metaadatok -->
                    <div class="item-metadata" data-link="${item.link}" data-episode="${item.epiz√≥d}">
                        ${metadataContent}
                    </div>

                    <div class="item-notes-container">
                        ${notesDisplay}
                        <div class="action-buttons" style="margin-top: 5px; justify-content: flex-end;">
                            <!-- Megjegyz√©s Szerkeszt√©s/Ment√©s/M√©gse -->
                            <button class="action-button" data-id="${item.id}" data-action="edit-notes" title="Megjegyz√©s szerkeszt√©se" style="${editNotesBtnStyle}">Megjegyz√©s ‚úé</button>
                            <button class="action-button" data-id="${item.id}" data-action="save-notes" title="Megjegyz√©s ment√©se" style="${saveNotesBtnStyle}">Ment√©s</button>
                            <button class="action-button" data-id="${item.id}" data-action="cancel-notes" title="M√©gse" style="${cancelNotesBtnStyle}">M√©gse</button>
                            
                            <!-- T√∂rl√©s -->
                            <button class="action-button" data-id="${item.id}" data-action="delete-media" title="T√∂rl√©s" style="color: #ff3b30;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            
                if (item.statusz === 'j√°tszand√≥') {
                    nezendoUl.appendChild(li);
                    nezendoCount++;
                } else {
                    megnezveUl.appendChild(li);
                    megnezveCount++;
                }
            });
            
            nezendoEmptyMessage.style.display = nezendoCount > 0 ? 'none' : 'block';
            megnezveEmptyMessage.style.display = megnezveCount > 0 ? 'none' : 'block';
        }

        // === KERES√âS FUNKCI√ì ===
        function filterAndDisplay() {
            const query = searchInput.value.toLowerCase().trim();
            
            if (query === '') {
                displayMediaItems(allMediaItems);
                return;
            }

            const filteredItems = allMediaItems.filter(item => 
                item.title.toLowerCase().includes(query)
            );

            displayMediaItems(filteredItems);
        }

        // Val√≥s idej≈± figyel≈ë be√°ll√≠t√°sa (adatok let√∂lt√©se a Firestore-b√≥l)
        function setupRealtimeListener() {
            if (!db || !userId) return;

            const collectionPath = `artifacts/${appId}/users/${userId}/media_tracker`;
            const mediaCollectionRef = collection(db, collectionPath);
            const q = query(mediaCollectionRef); 

            onSnapshot(q, (snapshot) => {
                const itemsToDisplay = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // Alap√©rtelmezett √©rt√©kek biztos√≠t√°sa
                    data.title = data.title || 'N√©vtelen elem'; 
                    data.notes = data.notes || '';
                    data.link = data.link || ''; 
                    data.epiz√≥d = data.epiz√≥d !== undefined ? data.epiz√≥d : 0; 

                    itemsToDisplay.push({ id: doc.id, ...data });
                });
                
                allMediaItems = itemsToDisplay; 
                
                // Rendez√©s (leg√∫jabb fel√ºlre)
                allMediaItems.sort((a, b) => (b.hozzaadva?.toMillis() || 0) - (a.hozzaadva?.toMillis() || 0));

                filterAndDisplay(); 
                
            }, (error) => {
                displayError(`Hiba a val√≥s idej≈± figyel≈ëben: ${error.message}`);
            });
        }
        
        // === ESEM√âNY DELEG√ÅCI√ì A DINAMIKUS GOMBOKHOZ ===
        document.addEventListener('click', function(event) {
            const target = event.target.closest('button[data-action]');
            if (!target) return; 

            const firestoreId = target.getAttribute('data-id');
            const action = target.getAttribute('data-action');
            const currentStatus = target.getAttribute('data-status');
            
            // C√≠m/Link/Epiz√≥d Szerkeszt√©s / Ment√©s / M√©gse
            if (action === 'edit-media') {
                // Csak akkor engedj√ºk a szerkeszt√©st, ha nincs m√°s szerkeszt√©s alatt
                if (currentNotesEditingId) {
                    displayError('K√©rem, mentse vagy szak√≠tsa meg az aktu√°lis jegyzet szerkeszt√©s√©t, miel≈ëtt c√≠met m√≥dos√≠t.');
                    return;
                }
                toggleEditMode(firestoreId);
            } else if (action === 'save-media') {
                if (firestoreId) saveNewTitle(firestoreId);
            } else if (action === 'cancel-media') {
                if (firestoreId) toggleEditMode(firestoreId);
            
            // Megjegyz√©s Szerkeszt√©s / Ment√©s / M√©gse
            } else if (action === 'edit-notes') {
                // Csak akkor engedj√ºk a szerkeszt√©st, ha nincs m√°s szerkeszt√©s alatt
                if (currentEditingId) {
                    displayError('K√©rem, mentse vagy szak√≠tsa meg az aktu√°lis c√≠m szerkeszt√©s√©t, miel≈ëtt jegyzetet m√≥dos√≠t.');
                    return;
                }
                toggleNotesEditMode(firestoreId);
            } else if (action === 'save-notes') {
                if (firestoreId) saveNotes(firestoreId);
            } else if (action === 'cancel-notes') {
                if (firestoreId) toggleNotesEditMode(firestoreId);
            
            // St√°tusz v√°lt√°s
            } else if (action === 'toggle-status') {
                toggleStatus(firestoreId, currentStatus);
            
            // T√∂rl√©s
            } else if (action === 'delete-media') {
                deleteMedia(firestoreId);
            }
        });

        // Kezd≈ë l√©p√©s: Firebase inicializ√°l√°sa
        window.onload = initializeFirebase;

    </script>
</body>
</html>
